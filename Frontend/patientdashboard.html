<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="patientdashboard.css" class="styleshhet">

</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <h4>Patient Dashboard</h4>
        <a href="#addAppointment" onclick="showSection('addAppointment')"><i class="fa fa-calendar-plus"></i> Add
            Appointment</a>
        <a href="#checkAppointment" onclick="showSection('checkAppointment')"><i class="fa fa-calendar-check"></i> Check
            Appointments</a>
        <a href="#profile" onclick="showSection('profile')"><i class="fa fa-user"></i> Get Profile</a>
        <a href="#index.html" onclick="logout()"><i class="fa fa-sign-out-alt"></i> Logout</a>
    </div>

    <!-- Header -->
    <div class="header">
        <h5>Welcome, Patient</h5>
        <div class="user-menu" onclick="toggleDropdown()">
            <!-- <img src="https://via.placeholder.com/40" alt="User" id="user-image"> -->
            <span id="name"></span> <!-- This will be dynamically updated -->
            <div class="dropdown">
                <a href="#profile" onclick="showSection('profile')"><i class="fa fa-user"></i>Profile</a>
                <a href="index.html" onclick="logout()"><i class="fa fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Fetch patient profile details after the DOM is fully loaded
            fetchPatientProfile();
        });

        // Fetch patient profile details
        function fetchPatientProfile() {
            // Get the patient UID from localStorage (if it is stored during login)
            const patientUid = localStorage.getItem('patient_uid'); // Assuming UID is stored in local storage during login
            const token = localStorage.getItem('access_token'); // Assuming token is saved in local storage

            if (!token) {
                console.error('No token found!');
                return;
            }

            if (!patientUid) {
                console.error('No patient UID found!');
                return;
            }

            const url = `http://127.0.0.1:8000/patient/${patientUid}/profile`; // Your API endpoint

            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                },
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Data received from API:', data); // Log the data received
                    if (data.patient) {
                        const patient = data.patient;

                        // Update the user menu with patient's name
                        const nameElement = document.getElementById('name');
                        if (nameElement) {
                            nameElement.textContent = `${patient.firstname} ${patient.lastname}`;
                            console.log('Updated name:', nameElement.textContent); // Log the updated name
                        } else {
                            console.error('Element with ID "name" not found.');
                        }

                        // Optionally, you can also update the profile image if available
                        document.getElementById('user-image').src = patient.profile_image || "https://via.placeholder.com/40";
                    } else {
                        console.error('Patient details not found.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching patient details:', error);
                });
        }
    </script>






    <!-- Main Content -->
    <div class="main">
        <div class="hidden">
            <div class="hero">
                <div class="content">
                    <p>
                        COMMITTED TO SUCCESS
                    </p>
                    <h1>
                        WE CARE ABOUT YOUR
                        <span>
                            HEALTH
                        </span>
                    </h1>
                    <p class="description">
                        Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
                        consequat is aute irure.
                    </p>
                    <p class="description">
                        Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
                        consequat is aute irure.
                    </p>
                </div>
                <div class="image">
                    <img alt="Doctor smiling with stethoscope" height="500"
                        src="https://storage.googleapis.com/a1aa/image/wWTkhRFqgtIoHlYCxcp5EKTpGTCEH9yfgNqda6NMSRJG4teTA.jpg"
                        width="500" />
                </div>
            </div>
        </div>





        <!-- Add Appointment Start -->
        <div id="addAppointment" class="hidden">
            <h2>Add Appointment</h2>
            <form id="appointmentForm">
                <div class="mb-3">
                    <label for="doctorRegno" class="form-label">Doctor</label>
                    <select class="form-control" id="doctorRegno" required>
                        <option value="" disabled selected>Select Doctor</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="appointmentDate" class="form-label">Date</label>
                    <input type="date" class="form-control" id="appointmentDate" required>
                </div>
                <div class="mb-3">
                    <label for="appointmentTime" class="form-label">Time</label>
                    <input type="time" class="form-control" id="appointmentTime" required>
                </div>
                <div class="mb-3">
                    <label for="day" class="form-label">Day</label>
                    <input type="text" class="form-control" id="day" required readonly>
                </div>
                <div class="mb-3">
                    <label for="symptoms" class="form-label">Symptoms</label>
                    <textarea class="form-control" id="symptoms" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const token = localStorage.getItem('access_token');
                const patientUid = localStorage.getItem('patient_uid');
                if (token) {
                    // Set the Patient UID field in the form
                    document.getElementById('patientUid').value = patientUid;

                    // Set the minimum date to tomorrow
                    const today = new Date();
                    today.setDate(today.getDate() + 1); // Set to tomorrow
                    const minDate = today.toISOString().split('T')[0]; // Format as YYYY-MM-DD
                    document.getElementById('appointmentDate').setAttribute('min', minDate);

                    // Add event listener to prevent selecting Sundays
                    document.getElementById('appointmentDate').addEventListener('change', (e) => {
                        const selectedDate = new Date(e.target.value);
                        const dayName = selectedDate.toLocaleString('en-us', { weekday: 'long' }); // Get the full name of the day
                        document.getElementById('day').value = dayName;

                        if (dayName === 'Sunday') {
                            alert('Appointments cannot be scheduled on Sundays. Please select another date.');
                            e.target.value = ''; // Clear the selected date
                            document.getElementById('day').value = ''; // Clear the day field
                        }
                    });

                    // Fetch available doctors to populate the doctor selection dropdown
                    fetchDoctors();

                    // Handle form submission
                    document.getElementById('appointmentForm').addEventListener('submit', (e) => {
                        e.preventDefault();
                        addAppointment(patientUid);
                    });
                } else {
                    console.error('No token found in localStorage.');
                }
            });

            // Function to fetch doctors and populate the dropdown
            function fetchDoctors() {
                const token = localStorage.getItem('access_token');
                const patientUid = localStorage.getItem('patient_uid'); // Retrieve the patient UID

                if (!patientUid) {
                    console.error('Patient UID not found in localStorage.');
                    return;
                }

                const url = `http://127.0.0.1:8000/patient/${patientUid}/doctors/`;

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.doctors) {
                            const doctorSelect = document.getElementById('doctorRegno');
                            data.doctors.forEach(doctor => {
                                const option = document.createElement('option');
                                option.value = doctor.regno;
                                option.textContent = `${doctor.firstname} ${doctor.lastname}`;
                                doctorSelect.appendChild(option);
                            });
                        } else {
                            console.error('Doctors data is missing in the response');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching doctors:', error);
                    });
            }

            // Function to add an appointment
            function addAppointment(patientUid) {
                const token = localStorage.getItem('access_token');
                const doctorRegno = document.getElementById('doctorRegno').value;
                const appointmentDate = document.getElementById('appointmentDate').value;
                const appointmentTime = document.getElementById('appointmentTime').value;
                const day = document.getElementById('day').value;
                const symptoms = document.getElementById('symptoms').value;

                if (!doctorRegno || !appointmentDate || !appointmentTime || !symptoms) {
                    console.error('All fields must be filled out.');
                    return;
                }

                const appointmentData = {
                    patient_uid: patientUid,
                    doctor_regno: doctorRegno,
                    date: appointmentDate,
                    time: appointmentTime,
                    day: day,
                    symptoms: symptoms,
                    status: 'PENDING', // Default status to PENDING
                };

                fetch(`http://127.0.0.1:8000/patient/${patientUid}/appointments`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(appointmentData),
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Appointment added successfully:', data);

                        // Show success message
                        alert('Appointment added successfully');

                        // Refresh the page
                        location.reload();
                    })
                    .catch(error => {
                        console.error('Error adding appointment:', error);
                    });
            }
        </script>
        <!-- Add Appointment Stop -->


        <!-- Check Appointment Start-->
        <div id="checkAppointment" class="hidden">
            <h2>Check Appointments</h2>
            <div>
                <label for="filterDate">Filter by Date: </label>
                <input type="date" id="filterDate" onchange="filterAppointmentsByDate()" />
            </div>
            <p id="appointmentMessage"></p>
            <table id="appointmentsTable" class="table table-striped" style="display: none;">
                <thead>
                    <tr>
                        <th>Sr.No</th>
                        <th>Doctor Name</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Day</th>
                        <th>Symptoms</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="appointmentsList"></tbody>
            </table>
            <!-- Pagination Controls -->
            <div id="paginationControls" style="display: none; text-align: center;">
                <button id="prevPage" class="btn btn-secondary" onclick="goToPage(currentPage - 1)">Previous</button>
                <span id="pageNumber"></span>
                <button id="nextPage" class="btn btn-secondary" onclick="goToPage(currentPage + 1)">Next</button>
            </div>
            <form id="appointmentForm" style="display: none;">
                <div class="mb-3">
                    <label for="patientUid" class="form-label">Patient UID</label>
                    <input type="number" class="form-control" id="patientUid" required readonly>
                </div>
                <div class="mb-3">
                    <label for="doctorRegno" class="form-label">Doctor Registration No.</label>
                    <select class="form-control" id="doctorRegno" required>
                        <option value="" disabled selected>Select Doctor</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="appointmentDate" class="form-label">Date</label>
                    <input type="date" class="form-control" id="appointmentDate" required>
                </div>
                <div class="mb-3">
                    <label for="appointmentTime" class="form-label">Time</label>
                    <input type="time" class="form-control" id="appointmentTime" required>
                </div>
                <div class="mb-3">
                    <label for="day" class="form-label">Day</label>
                    <input type="text" class="form-control" id="day" readonly>
                </div>
                <div class="mb-3">
                    <label for="symptoms" class="form-label">Symptoms</label>
                    <textarea class="form-control" id="symptoms" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Update appointment</button>
            </form>
        </div>
        <!-- Modal HTML -->
        <div class="modal fade" id="updateAppointmentModal" tabindex="-1" aria-labelledby="updateAppointmentLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="updateAppointmentLabel">Update Appointment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="updateAppointmentForm">
                            <input type="hidden" id="appointmentId" />
                            <div class="mb-3">
                                <label for="updateDoctorName" class="form-label">Doctor Name</label>
                                <select class="form-control" id="updateDoctorName" required>
                                    <option value="" disabled selected>Select Doctor</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="updateDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="updateDate" required />
                            </div>
                            <div class="mb-3">
                                <label for="updateTime" class="form-label">Time</label>
                                <input type="time" class="form-control" id="updateTime" required />
                            </div>
                            <div class="mb-3">
                                <label for="updateSymptoms" class="form-label">Symptoms</label>
                                <textarea class="form-control" id="updateSymptoms" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Showing All Appointment Start -->
        <script>
            let currentPage = 1;
            const appointmentsPerPage = 10;

            // Fetch all appointments and update the UI
            function fetchAppointments() {
                const token = localStorage.getItem('access_token');
                const patientUid = localStorage.getItem('patient_uid'); // Get the patient UID dynamically from localStorage

                if (!token || !patientUid) {
                    console.error('Token or Patient UID not found!');
                    return;
                }

                const url = `http://127.0.0.1:8000/patient/${patientUid}/appointments`;

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        // Remove `T` and time from date
                        data.appointments.forEach(appointment => {
                            appointment.date = appointment.date.split('T')[0]; // Format as YYYY-MM-DD
                        });
                        displayAppointments(data.appointments);
                    })
                    .catch(error => {
                        console.error('Error fetching appointments:', error);
                        document.getElementById('appointmentMessage').textContent = 'No Appointment Found. You May Need Add Appointment First!';
                    });
            }

            // Filter appointments by date and update the table
            async function filterAppointmentsByDate() {
                const filterDate = document.getElementById('filterDate').value;
                console.log(filterDate);
                const patientUid = localStorage.getItem('patient_uid'); // Get the patient UID dynamically
                const token = localStorage.getItem('access_token');

                // Validate date format (YYYY-MM-DD)
                if (!/^\d{4}-\d{2}-\d{2}$/.test(filterDate)) {
                    document.getElementById('appointmentMessage').textContent = 'Invalid date format. Please use YYYY-MM-DD.';
                    return;
                }

                if (!filterDate) {
                    fetchAppointments(); // Fetch all appointments if no date is selected
                    return;
                }

                const url = `http://127.0.0.1:8000/patient/${patientUid}/appointments/date/${filterDate}`;

                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                        },
                    });

                    if (!response.ok) {
                        throw new Error('Error fetching appointments.');
                    }

                    const data = await response.json();
                    console.log('Response data:', data);

                    if (data && data.appointments_data && data.appointments_data.length > 0) {
                        // Remove `T` and time from date
                        data.appointments_data.forEach(appointment => {
                            appointment.date = appointment.date.split('T')[0]; // Format as YYYY-MM-DD
                        });
                        displayAppointments(data.appointments_data);
                        console.log('Appointments:', data);
                    } else {
                        document.getElementById('appointmentMessage').textContent = 'No appointments found for the selected date.';
                        clearAppointmentsTable();
                    }
                } catch (error) {
                    console.error('Error fetching appointments:', error);
                    document.getElementById('appointmentMessage').textContent = 'Error fetching appointments.';
                }
            }

            function clearAppointmentsTable() {
                const appointmentsList = document.getElementById('appointmentsList');
                appointmentsList.innerHTML = ''; // Clear all rows
                document.getElementById('appointmentsTable').style.display = 'none'; // Hide the table
            }

            // Display appointments in the table
            function displayAppointments(appointments) {
                const appointmentsList = document.getElementById('appointmentsList');
                const appointmentMessage = document.getElementById('appointmentMessage');
                const appointmentsTable = document.getElementById('appointmentsTable');

                if (appointments.length === 0) {
                    appointmentMessage.textContent = 'No appointments available.';
                    appointmentsTable.style.display = 'none';
                } else {
                    appointmentMessage.textContent = '';
                    appointmentsTable.style.display = 'table';

                    // Paginate appointments (show 10 at a time)
                    const startIndex = (currentPage - 1) * appointmentsPerPage;
                    const endIndex = startIndex + appointmentsPerPage;
                    const paginatedAppointments = appointments.slice(startIndex, endIndex);

                    // Clear the existing table rows
                    appointmentsList.innerHTML = '';

                    // Loop through the appointments and add rows to the table
                    paginatedAppointments.forEach((appointment, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td>${startIndex + index + 1}</td>
                        <td>${appointment.doctor_name}</td>
                        <td>${appointment.date}</td>
                        <td>${appointment.time}</td>
                        <td>${appointment.day}</td>
                        <td>${appointment.symptoms}</td>
                        <td>${appointment.status}</td>
                        <td>
                            <button class="btn btn-warning" onclick="cancelAppointment(${appointment.appointment_id})">Cancel</button>
                            <button class="btn btn-primary" onclick="openUpdateModal(${appointment.appointment_id})">Update</button>
                        </td>
                    `;
                        appointmentsList.appendChild(row);
                    });

                    // Show pagination controls if more than 10 appointments
                    if (appointments.length > appointmentsPerPage) {
                        document.getElementById('paginationControls').style.display = 'block';
                        updatePaginationControls(appointments.length);
                    } else {
                        document.getElementById('paginationControls').style.display = 'none';
                    }
                }
            }

            // Update pagination controls
            function updatePaginationControls(totalAppointments) {
                const totalPages = Math.ceil(totalAppointments / appointmentsPerPage);
                const prevBtn = document.getElementById('prevPage');
                const nextBtn = document.getElementById('nextPage');
                const pageNum = document.getElementById('pageNumber');

                pageNum.textContent = `Page ${currentPage} of ${totalPages}`;

                // Enable/disable prev and next buttons
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
            }

            // Handle pagination actions
            function goToPage(pageNumber) {
                currentPage = pageNumber;
                fetchAppointments(); // Fetch appointments for the current page
            }

            // Fetch all appointments on page load
            fetchAppointments();
        </script>
        <!-- Showing All Appointment Stop -->

        <!-- Cancel Appointment Start -->
        <script>
            function cancelAppointment(appointmentId) {
                const patientUid = localStorage.getItem('patient_uid'); // Retrieve patient UID from localStorage
                const token = localStorage.getItem('access_token'); // Retrieve access token from localStorage

                if (!patientUid || !token) {
                    console.error('Patient UID or access token not found!');
                    alert('You are not authorized to perform this action.');
                    return;
                }

                // Construct the API URL
                const url = `http://127.0.0.1:8000/patient/${patientUid}/appointment/${appointmentId}`;

                // Make the DELETE request to the API
                fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json(); // Parse the JSON response
                        } else {
                            throw new Error('Failed to cancel the appointment');
                        }
                    })
                    .then(data => {
                        // Display success message
                        alert(data.detail);

                        // Optionally, refresh the appointments list
                        fetchAppointments();
                    })
                    .catch(error => {
                        console.error('Error canceling appointment:', error);
                        alert('Error canceling the appointment. Please try again.');
                    });
            }

        </script>
        <!-- Cancel Appointment Stop -->
        <!-- Update Appointment Modal Open Start -->
        <script>
            // This function will be called when the Update button is clicked
            function openUpdateModal(appointmentId) {
                // Set the appointmentId in the modal
                document.getElementById('appointmentId').value = appointmentId;

                // Get the current date
                const today = new Date();
                today.setDate(today.getDate() + 1); // Move to tomorrow
                const tomorrow = today.toISOString().split('T')[0]; // Format it as YYYY-MM-DD

                // Set the min attribute of the date input field to tomorrow's date
                const updateDateInput = document.getElementById('updateDate');
                updateDateInput.min = tomorrow;

                // Disable Sundays (to exclude Sundays from selection)
                updateDateInput.addEventListener('input', function () {
                    const selectedDate = new Date(updateDateInput.value);
                    if (selectedDate.getDay() === 0) {  // Sunday = 0
                        alert("Sunday is not allowed. Please select another date.");
                        updateDateInput.setCustomValidity("Sunday is not allowed.");
                    } else {
                        updateDateInput.setCustomValidity("");
                    }
                });

                // Fetch appointment details using the API
                fetchAppointmentDetails(appointmentId);

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('updateAppointmentModal'));
                modal.show();
            }

            // Fetch appointment details using the FastAPI endpoint
            async function fetchAppointmentDetails(appointmentId) {
                const patientId = localStorage.getItem("patient_uid");  // Replace this with the actual patient ID
                const url = `http://127.0.0.1:8000/patient/${patientId}/appointment/${appointmentId}`;

                // Log the URL to check it
                console.log("Fetching appointment from URL:", url);

                // Retrieve token from localStorage or sessionStorage
                const token = localStorage.getItem("access_token");  // or sessionStorage.getItem("auth_token");

                if (!token) {
                    console.error("Token is missing. Please log in.");
                    return;
                }

                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,  // Pass the token in the Authorization header
                            'Content-Type': 'application/json',
                        }
                    });

                    // Check if the response is ok (200-299)
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();

                    // Log the fetched data
                    console.log("Fetched appointment data:", data);

                    // Check if data contains the appointment info
                    if (data.appointment) {
                        populateAppointmentForm(data.appointment);
                    } else {
                        throw new Error("Appointment not found in the response.");
                    }

                } catch (error) {
                    // Log the full error to understand what's going wrong
                    console.error("Error fetching appointment details:", error.message);
                }
            }

            // Populate the form with the fetched appointment details
            function populateAppointmentForm(appointment) {
                // Set the doctor's name (this is preselected from the fetched appointment)
                const doctorSelect = document.getElementById('updateDoctorName');

                // First clear existing options
                doctorSelect.innerHTML = '';

                // Add the placeholder option
                const placeholderOption = document.createElement('option');
                placeholderOption.textContent = 'Select a Doctor';
                placeholderOption.disabled = true;
                placeholderOption.selected = true;
                doctorSelect.appendChild(placeholderOption);

                // Add the preselected doctor option
                const doctorOption = document.createElement('option');
                doctorOption.value = appointment.doctor_regno; // Preselect the current doctor
                doctorOption.textContent = `${appointment.doctor_name}`;
                doctorOption.selected = true; // Ensure it's selected
                doctorSelect.appendChild(doctorOption);

                // Fetch doctors to populate the remaining options
                fetchDoctors(appointment.doctor_regno);

                // Set the date (and time if needed)
                document.getElementById('updateDate').value = appointment.date.split('T')[0]; // Date format (YYYY-MM-DD)

                // Set the time (if time is separate, adjust the field accordingly)
                document.getElementById('updateTime').value = appointment.time; // Assuming `time` is part of the response, adjust if needed

                // Set the symptoms
                document.getElementById('updateSymptoms').value = appointment.symptoms;  // Assuming `symptoms` is part of the response, if not, adjust this part
            }

            // Function to fetch doctors and populate the doctor dropdown in the modal
            function fetchDoctors(selectedDoctorRegno) {
                const token = localStorage.getItem('access_token');
                const patientUid = localStorage.getItem('patient_uid'); // Retrieve the patient UID

                if (!patientUid) {
                    console.error('Patient UID not found in localStorage.');
                    return;
                }

                const url = `http://127.0.0.1:8000/patient/${patientUid}/doctors/`;

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.doctors) {
                            const doctorSelect = document.getElementById('updateDoctorName');

                            // Add the other doctors to the dropdown list
                            data.doctors.forEach(doctor => {
                                // Skip the preselected doctor to avoid duplicating
                                if (doctor.regno !== selectedDoctorRegno) {
                                    const option = document.createElement('option');
                                    option.value = doctor.regno; // Assuming doctor.regno is the identifier
                                    option.textContent = `${doctor.firstname} ${doctor.lastname}`;
                                    doctorSelect.appendChild(option);
                                }
                            });
                        } else {
                            console.error('Doctors data is missing in the response');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching doctors:', error);
                    });
            }
        </script>
        <!-- Update Appointment Modal Open Stop -->
        <!-- Update Appointment Start -->
        <script>
            // This function will be called when the "Save Changes" button is clicked
            document.getElementById('updateAppointmentForm').addEventListener('submit', async function (event) {
                event.preventDefault(); // Prevent default form submission

                // Get the appointment ID from the hidden input field
                const appointmentId = document.getElementById('appointmentId').value;

                // Get the updated values from the form inputs
                const doctorName = document.getElementById('updateDoctorName').value;
                const date = document.getElementById('updateDate').value;
                const time = document.getElementById('updateTime').value;
                const symptoms = document.getElementById('updateSymptoms').value;

                // Prepare the updated data
                const updatedData = {
                    doctor_regno: doctorName,
                    date: date,
                    time: time,
                    symptoms: symptoms
                };

                // Get the patient ID from localStorage
                const patientId = localStorage.getItem("patient_uid");  // Replace this with the actual patient ID
                if (!patientId) {
                    console.error("Patient ID is missing.");
                    return;
                }

                // Get the authorization token
                const token = localStorage.getItem("access_token");
                if (!token) {
                    console.error("Authorization token is missing.");
                    return;
                }

                // Prepare the API URL
                const url = `http://127.0.0.1:8000/patient/${patientId}/appointment/${appointmentId}`;

                try {
                    // Make a PUT request to the FastAPI endpoint
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedData)
                    });

                    // Check if the response is ok
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }

                    // Parse the response data
                    const data = await response.json();
                    console.log("Appointment updated:", data);

                    // Optionally, you can display a success message or update the UI
                    alert("Appointment updated successfully!");

                    // Close the modal after successful update
                    const modal = bootstrap.Modal.getInstance(document.getElementById('updateAppointmentModal'));
                    modal.hide();

                    // Refresh the page to reflect the updated appointment
                    window.location.reload();

                } catch (error) {
                    // Log the error if the update fails
                    console.error("Error updating appointment:", error.message);
                    alert("Failed to update the appointment. Please try again.");
                }
            });

        </script>
        <!-- Update Appointment Stop -->

        <!-- Check Appointment Stop -->


        <!-- Profile Start -->
        <div id="profile" class="hidden">
            <h2>Profile</h2>
            <div class="mb-3">
                <label for="profileName" class="form-label">Name</label>
                <input type="text" class="form-control" id="profileName" required readonly>
            </div>
            <div class="mb-3">
                <label for="profileGender" class="form-label">Gender</label>
                <input type="text" class="form-control" id="profileGender" required readonly>
            </div>
            <div class="mb-3">
                <label for="profileAddress" class="form-label">Address</label>
                <input type="text" class="form-control" id="profileAddress" required readonly>
            </div>
            <div class="mb-3">
                <label for="profileDOB" class="form-label">Date of Birth</label>
                <input type="text" class="form-control" id="profileDOB" required readonly>
            </div>
            <div class="mb-3">
                <label for="profileMobile" class="form-label">Mobile Number</label>
                <input type="text" class="form-control" id="profileMobile" required readonly>
            </div>

            <button type="button" class="btn btn-primary" onclick="openUpdateProfileModal()">Update Profile</button>
        </div>
        <div class="modal fade" id="updateProfileModal" tabindex="-1" aria-labelledby="updateProfileModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="updateProfileModalLabel">Update Profile</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="updateProfileForm">
                    <div class="mb-3">
                      <label for="modalProfileName" class="form-label">Name</label>
                      <input type="text" class="form-control" id="modalProfileName" required>
                    </div>
                    <div class="mb-3">
                        <label for="modalProfileGender" class="form-label">Gender</label>
                        <select class="form-control" id="modalProfileGender" required>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                      <label for="modalProfileAddress" class="form-label">Address</label>
                      <input type="text" class="form-control" id="modalProfileAddress" required>
                    </div>
                    <div class="mb-3">
                      <label for="modalProfileDOB" class="form-label">Date of Birth</label>
                      <input type="text" class="form-control" id="modalProfileDOB" required>
                    </div>
                    <div class="mb-3">
                      <label for="modalProfileMobile" class="form-label">Mobile Number</label>
                      <input type="text" class="form-control" id="modalProfileMobile" required>
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" onclick="saveProfileChanges()">Save Changes</button>
                </div>
              </div>
            </div>
        </div>
        <!-- Fetch Patient Profile Data Start -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const token = localStorage.getItem('access_token');
                const patientUid = localStorage.getItem('patient_uid');  // Assuming this is stored in localStorage

                if (patientUid && token) {
                    // Fetch patient profile from the API
                    fetch(`http://127.0.0.1:8000/patient/${patientUid}/profile`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.patient) {
                                // Fill form fields with the patient data
                                const patient = data.patient;
                                document.getElementById('profileName').value = `${patient.firstname} ${patient.lastname}`;
                                document.getElementById('profileGender').value = patient.gender; 
                                document.getElementById('profileAddress').value = patient.address;
                                document.getElementById('profileDOB').value = patient.date_of_birth;
                                document.getElementById('profileMobile').value = patient.mobile_number;
                            } else {
                                console.error('Error fetching patient profile');
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching patient profile:', error);
                        });
                } else {
                    console.error('No patient UID or token found');
                }
            });

        </script>
        <!-- Fetch Patient Profile Data Stop -->

        <!-- Open Modal For Update Profile -->
        <script>
            // Open the modal and populate it with current profile data
function openUpdateProfileModal() {
    // Get current profile data
    const profileName = document.getElementById('profileName').value;
    const profileGender = document.getElementById('profileGender').value;
    const profileAddress = document.getElementById('profileAddress').value;
    const profileDOB = document.getElementById('profileDOB').value;
    const profileMobile = document.getElementById('profileMobile').value;

    // Populate the modal with the current profile data
    document.getElementById('modalProfileName').value = profileName;
    document.getElementById('modalProfileGender').value = profileGender;
    document.getElementById('modalProfileAddress').value = profileAddress;
    document.getElementById('modalProfileDOB').value = profileDOB;
    document.getElementById('modalProfileMobile').value = profileMobile;

    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('updateProfileModal'));
    modal.show();
}

// Save the updated profile details
function saveProfileChanges() {
    // Get updated values from the modal
    const updatedName = document.getElementById('modalProfileName').value;
    const updatedGender = document.getElementById('modalProfileGender').value;
    const updatedAddress = document.getElementById('modalProfileAddress').value;
    const updatedDOB = document.getElementById('modalProfileDOB').value;
    const updatedMobile = document.getElementById('modalProfileMobile').value;

    // Update the profile data in the main profile section
    document.getElementById('profileName').value = updatedName;
    document.getElementById('profileGender').value = updatedGender;
    document.getElementById('profileAddress').value = updatedAddress;
    document.getElementById('profileDOB').value = updatedDOB;
    document.getElementById('profileMobile').value = updatedMobile;

    // Hide the modal after saving changes
    const modal = bootstrap.Modal.getInstance(document.getElementById('updateProfileModal'));
    modal.hide();

    // Optionally, you can send an API request here to save the changes to the server.
    // Example: saveProfileToServer(updatedName, updatedGender, updatedAddress, updatedDOB, updatedMobile);
}

        </script>
        <!-- Open Modal For Update Profile -->

        <!-- Save Updated Profile Start -->
        <script>
            function saveProfileChanges() {
    // Get updated values from the modal
    const updatedName = document.getElementById('modalProfileName').value;
    const updatedGender = document.getElementById('modalProfileGender').value;
    const updatedAddress = document.getElementById('modalProfileAddress').value;
    const updatedDOB = document.getElementById('modalProfileDOB').value;
    const updatedMobile = document.getElementById('modalProfileMobile').value;

    // Prepare the updated data to send to the server
    const updatedData = {
        firstname: updatedName.split(' ')[0],  // Assuming first name is the first part of the full name
        lastname: updatedName.split(' ')[1],   // Assuming last name is the second part
        gender: updatedGender,
        address: updatedAddress,
        date_of_birth: updatedDOB,
        mobile_number: updatedMobile
    };

    const patientUid = localStorage.getItem('patient_uid');
    const token = localStorage.getItem('access_token');

    if (!patientUid || !token) {
        console.error('Patient UID or access token is missing');
        return;
    }

    // Send the updated data to the API
    fetch(`http://127.0.0.1:8000/patient/${patientUid}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify(updatedData)
    })
        .then(response => response.json())
        .then(data => {
            if (data.detail) {
                console.log(data.detail); // You can display a success message here
                // Update the profile in the main profile section
                document.getElementById('profileName').value = updatedName;
                document.getElementById('profileGender').value = updatedGender;
                document.getElementById('profileAddress').value = updatedAddress;
                document.getElementById('profileDOB').value = updatedDOB;
                document.getElementById('profileMobile').value = updatedMobile;
                // Hide the modal after saving changes
                const modal = bootstrap.Modal.getInstance(document.getElementById('updateProfileModal'));
                modal.hide();
            } else {
                console.error('Error updating patient profile:', data);
            }
        })
        .catch(error => {
            console.error('Error sending the PUT request:', error);
        });
}

        </script>
        <!-- Save Updated Profile Stop -->

        <!-- Profile Stop -->



    </div>

    <script>
        function showSection(sectionId) {
            document.querySelectorAll('.main > div').forEach(div => {
                div.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function updateProfile() {
            const name = document.getElementById('profileName').value;
            const email = document.getElementById('profileEmail').value;
            alert(`Profile updated:\nName: ${name}\nEmail: ${email}`);
        }
    </script>
    <script>
        function toggleDropdown() {
            const dropdown = document.querySelector('.user-menu .dropdown');
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';
        }

        function logout() {
            alert('Logging out...');
            localStorage.removeItem('access_token');
            localStorage.removeItem('patient_uid');

            // Redirect to the login page or perform other logout operations
            window.location.href = 'index.html'; // Update with your login page URL
        }

        // Close dropdown if clicked outside
        document.addEventListener('click', function (event) {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.querySelector('.user-menu .dropdown');
            if (!userMenu.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });
    </script>
    <script>
        // Check if 'access_token' is not in local storage
        if (!localStorage.getItem('access_token')) {
            // If no access_token, redirect to index.html
            window.location.href = 'index.html';
        }

    </script>
    <script>
        // Fetch and populate the patient UID in the appointment form
        window.onload = function () {
            const token = localStorage.getItem('access_token');

            if (token) {
                // Optionally, you can parse the token to get the UID (if stored inside the token)
                // For simplicity, assuming the token is just the UID in this example.
                document.getElementById('patientUid').value = token;  // Replace with decoded UID if necessary
                console.log(patientUid);
            }
            console.log(patientUid);
        };
    </script>
</body>

</html>